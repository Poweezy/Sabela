// Performance Optimization System
const Performance = {
    init() {
        this.optimizeImages();
        this.addIntersectionObserver();
        this.preloadCriticalResources();
        this.optimizeAnimations();
    },

    optimizeImages() {
        // WebP support detection and fallback
        const supportsWebP = () => {
            const canvas = document.createElement('canvas');
            return canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0;
        };

        if (!supportsWebP()) {
            document.querySelectorAll('img[src*=".webp"]').forEach(img => {
                img.src = img.src.replace('.webp', '.jpg');
            });
        }

        // Progressive image loading
        document.querySelectorAll('img[data-src]').forEach(img => {
            const placeholder = document.createElement('div');
            placeholder.className = 'image-placeholder';
            placeholder.style.cssText = `
                width: 100%;
                height: 200px;
                background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
                border-radius: var(--radius-md);
            `;
            img.parentNode.insertBefore(placeholder, img);
            img.style.display = 'none';

            img.onload = () => {
                img.style.display = 'block';
                placeholder.remove();
            };
        });
    },

    addIntersectionObserver() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-slide-up');
                    observer.unobserve(entry.target);
                }
            });
        }, { 
            threshold: 0.1,
            rootMargin: '50px'
        });

        document.querySelectorAll('.card, .section-title, .section-intro').forEach(el => {
            observer.observe(el);
        });
    },

    preloadCriticalResources() {
        // Preload critical fonts
        const fontPreload = document.createElement('link');
        fontPreload.rel = 'preload';
        fontPreload.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap';
        fontPreload.as = 'style';
        document.head.appendChild(fontPreload);

        // Preload hero video
        const videoPreload = document.createElement('link');
        videoPreload.rel = 'preload';
        videoPreload.href = 'img/website-banner.mp4';
        videoPreload.as = 'video';
        document.head.appendChild(videoPreload);
    },

    optimizeAnimations() {
        // Reduce animations on low-end devices
        if (navigator.hardwareConcurrency <= 2) {
            document.documentElement.style.setProperty('--duration-normal', '150ms');
            document.documentElement.style.setProperty('--duration-slow', '300ms');
        }

        // Pause animations when tab is not visible
        document.addEventListener('visibilitychange', () => {
            const animatedElements = document.querySelectorAll('[style*="animation"]');
            animatedElements.forEach(el => {
                if (document.hidden) {
                    el.style.animationPlayState = 'paused';
                } else {
                    el.style.animationPlayState = 'running';
                }
            });
        });
    }
};

// Add shimmer animation CSS
const shimmerCSS = document.createElement('style');
shimmerCSS.textContent = `
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
`;
document.head.appendChild(shimmerCSS);

document.addEventListener('DOMContentLoaded', () => {
    Performance.init();
});